var crypto = require('crypto'); 
var rand = require('csprng'); 
var mongoose = require('mongoose'); 
var gravatar = require('gravatar'); 
var Event = require('config/modelEvent');  
var ActionModel = require('config/modelAction');

//Aggregation function
var getProgess = function() {
    Event.aggregate([
        { $unwind: "$usersActing" },
        { $group: {
            _id: null,
            balance: { $sum: "$usersActing.amountEnergy"  }
        }}
    ], function (err, balance) {
        if (err) {
            console.log(err);
            return;
        }
        console.log("**** BALANCE " + balance);
    });
}

exports.action = function(act,userEmail, callback) {  

    //Finding the last Event
    Event.findOne({}, {}, { sort: { 'date_action' : -1 } }, function(err, event) {

        //Add the action of the user to the ones of the actions
        var newAction = new ActionModel({ email : userEmail, amountEnergy : act });

	/*
        newAction.save(function(err) {
            if (err)
                throw err;
        });*/

        if(event.usersActing === undefined){
            event.usersActing[0] = newAction;
        }
        else{
            event.usersActing.push(newAction); 
        }
	
        event.save(function(err) {
            if (err) 
                throw err;
            console.log('Unexpected success!');    
        });
        
    });
    
    var progress = getProgess();
    callback({'response':progress, 'res':"true"});   
    
}
